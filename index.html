<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HabitTracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0071e3;
            --primary-light: #42a5f5;
            --primary-gradient: linear-gradient(135deg, #0071e3, #42a5f5);
            --light-gray: #f5f5f7;
            --border-color: #d2d2d7;
            --success-color: #34c759;
            --meditation-color: #e3f8e9;
            --vocab-color: #fef9c3;
            --gaming-color: #e3f2fd;
            --bg-color: #ffffff;
            --text-color: #1d1d1f;
            --text-light: #86868b;
            --cell-hover-color: #f5f5f7;
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 6px 12px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 12px 24px rgba(0, 0, 0, 0.12);
            --shadow-inner: inset 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-button: 0 2px 8px rgba(0, 113, 227, 0.3);
            --radius-sm: 0.5rem;
            --radius-md: 0.75rem;
            --radius-lg: 1rem;
            --font-sans: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', sans-serif;
        }
        
        [data-theme="dark"] {
            --primary-color: #0a84ff;
            --primary-light: #64b5f6;
            --primary-gradient: linear-gradient(135deg, #0a84ff, #64b5f6);
            --light-gray: #1c1c1e;
            --border-color: #38383a;
            --success-color: #30d158;
            --meditation-color: #0d3d29;
            --vocab-color: #3a3000;
            --gaming-color: #0a253e;
            --bg-color: #000000;
            --text-color: #f5f5f7;
            --text-light: #98989d;
            --cell-hover-color: #1c1c1e;
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.2);
            --shadow: 0 4px 8px rgba(0, 0, 0, 0.25);
            --shadow-md: 0 6px 12px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 12px 24px rgba(0, 0, 0, 0.35);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-sans);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            letter-spacing: -0.01em;
        }
        
        body {
            color: var(--text-color);
            background-color: var(--bg-color);
            transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
            line-height: 1.5;
            min-height: 100vh;
            background-image: 
                radial-gradient(at 100% 0%, rgba(0, 113, 227, 0.03) 0px, transparent 50%),
                radial-gradient(at 0% 100%, rgba(0, 113, 227, 0.03) 0px, transparent 50%);
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) var(--light-gray);
            -webkit-tap-highlight-color: transparent;
        }
        
        [data-theme="dark"] .header {
            background-color: var(--bg-color);
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 2.5rem;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--bg-color);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .header-button {
            background: transparent;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            padding: 0;
            transition: all 0.2s ease;
        }
        
        .header-button:hover {
            background-color: var(--light-gray);
        }
        
        .logo {
            font-size: 1.75rem;
            font-weight: 600;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.03em;
            transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        
        .theme-toggle {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
            font-size: 1.1rem;
            box-shadow: var(--shadow-sm);
        }

        .theme-toggle:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-light);
        }
        
        .month-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            padding: 3rem 0 2rem;
            background-color: transparent;
            position: relative;
        }
        
        .add-goal-nav-btn {
            position: absolute;
            right: 2.5rem;
            background: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            border-radius: var(--radius-sm);
            padding: 0.4rem 1rem;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .add-goal-nav-btn:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-1px);
        }
        
        .add-goal-nav-btn:active {
            transform: translateY(0);
        }
        
        .month-display {
            font-size: 2rem;
            font-weight: 600;
            color: var(--text-color);
            min-width: 280px;
            text-align: center;
            letter-spacing: -0.03em;
        }
        
        .nav-btn {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.1rem;
            width: 3rem;
            height: 3rem;
            color: var(--text-color);
            transition: all 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-sm);
        }

        .nav-btn:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            transform: translateY(-2px) scale(1.05);
            box-shadow: var(--shadow-button);
        }
        
        .calendar {
            margin: 0 2.5rem 2.5rem;
            border-radius: var(--radius-lg);
            background-color: var(--bg-color);
            box-shadow: var(--shadow-lg);
            border: 0.5px solid var(--border-color);
            overflow: hidden;
            transition: all 0.3s ease;
            position: relative;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        .calendar-inner {
            width: max-content;
            min-width: 100%;
            display: table;
            table-layout: fixed;
            border-collapse: separate;
            border-spacing: 0;
            overflow-x: auto;
            max-height: 70vh;
            scrollbar-width: thin;
            overflow-y: auto;
            outline: none;
            border: none;
            -webkit-tap-highlight-color: transparent;
            /* Fix scrollbar issues */
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) var(--light-gray);
        }

        /* Fix for Safari scrollbar issues */
        .calendar-inner::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .calendar-inner::-webkit-scrollbar-track {
            background: var(--light-gray);
            border-radius: 3px;
        }

        .calendar-inner::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 3px;
        }
        
        .calendar-header {
            display: table-row;
            background-color: var(--light-gray);
        }
        
        .header-cell {
            display: table-cell;
            padding: 0.5rem;
            text-align: center;
            border: 0.5px solid var(--border-color);
            font-weight: 600;
            font-size: 0.9rem;
            letter-spacing: 0.02em;
            background-color: var(--light-gray);
            transition: all 0.2s ease;
            vertical-align: middle;
            width: 40px;
            min-width: 40px;
            height: 45px;
            color: var(--text-light);
            position: relative;
        }
        
        .header-cell:first-child {
            width: 220px;
            min-width: 220px;
            text-align: left;
            padding: 0.5rem 1rem;
            background-color: var(--bg-color);
            font-weight: 700;
            color: var(--primary-color);
            border-top: none;
            font-size: 1rem;
            position: sticky;
            left: 0;
            z-index: 2;
        }
        
        .habit-row {
            display: table-row;
            background-color: var(--bg-color);
            transition: all 0.2s ease;
            /* Prevent any blue outline */
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .habit-name-container {
            display: table-cell;
            padding: 0.5rem 1rem;
            border: 0.5px solid var(--border-color);
            font-weight: 500;
            transition: all 0.2s ease;
            vertical-align: middle;
            background-color: var(--bg-color);
            width: 220px;
            min-width: 220px;
            position: sticky;
            left: 0;
            z-index: 2;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .habit-cell {
            display: table-cell;
            padding: 0.5rem;
            border: 0.5px solid var(--border-color);
            text-align: center;
            vertical-align: middle;
            transition: all 0.2s ease;
            position: relative;
            background-color: var(--bg-color);
            width: 40px;
            min-width: 40px;
            height: 45px;
            cursor: pointer;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        .habit-cell:hover {
            background-color: var(--cell-hover-color);
            transform: scale(1.05);
            z-index: 1;
            box-shadow: var(--shadow-md);
            /* Ensure no blue outline appears on hover */
            outline: none !important;
            border-color: var(--border-color) !important;
        }

        .day-cell {
            width: 40px;
            min-width: 40px;
            height: 45px;
            position: relative;
        }

        .weekday {
            font-size: 0.7rem;
            color: var(--text-light);
            margin-bottom: 0.15rem;
            line-height: 1;
            font-weight: 500;
        }

        .date {
            font-size: 0.9rem;
            font-weight: 600;
            line-height: 1;
            color: var(--text-color);
        }
        
        .completed {
            position: relative;
            background-color: var(--bg-color);
        }
        
        .completed::after {
            content: "‚úì";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--success-color);
            font-size: 1.25rem;
            font-weight: bold;
            opacity: 0;
            animation: checkmark 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes checkmark {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.3); }
            100% { opacity: 0.9; transform: translate(-50%, -50%) scale(1); }
        }
        
        .crossed {
            position: relative;
            background-color: var(--bg-color);
        }
        
        .crossed::after {
            content: "‚úó";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ef4444;
            font-size: 1.25rem;
            opacity: 0;
            animation: crossmark 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes crossmark {
            0% { opacity: 0; transform: translate(-50%, -50%) rotate(-45deg) scale(0.5); }
            50% { opacity: 1; transform: translate(-50%, -50%) rotate(0deg) scale(1.3); }
            100% { opacity: 0.7; transform: translate(-50%, -50%) rotate(0deg) scale(1); }
        }

        .header-cell.week-start,
        .habit-cell.week-start,
        .habit-name-container.week-start {
            border-left: 1px solid var(--border-color);
        }
        
        .header-cell.week-end,
        .habit-cell.week-end {
            border-right: 1px solid var(--border-color);
        }

        .habit-note {
            position: fixed;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 2rem;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: var(--shadow-lg);
            animation: fadeInScale 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        @keyframes fadeInScale {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.95); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        .note-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 999;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .has-note::before {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 8px 8px 0;
            border-color: transparent var(--primary-color) transparent transparent;
            opacity: 0.8;
            transition: all 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .has-note:hover::before {
            border-width: 0 10px 10px 0;
            opacity: 1;
        }

        .note-actions {
            margin-top: 1rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border-color);
        }

        .note-btn {
            padding: 0.5rem 1.25rem;
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .note-save {
            background: var(--primary-gradient);
            color: white;
            border: none;
        }

        .note-save:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
            box-shadow: var(--shadow-button);
        }

        .note-save:active {
            filter: brightness(0.95);
            transform: translateY(0);
            box-shadow: none;
        }

        .note-cancel {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }

        .note-cancel:hover {
            background-color: var(--cell-hover-color);
            transform: translateY(-1px);
        }

        .note-cancel:active {
            transform: translateY(0);
        }

        .habit-name {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.25rem;
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
            margin-right: 2rem;
        }

        .habit-row.dragging {
            opacity: 0.5;
            background-color: var(--light-gray);
            box-shadow: var(--shadow-lg);
        }
        
        .habit-row.drag-over {
            border-top: 2px solid var(--primary-color);
        }

        .today {
            position: relative;
            font-weight: 600;
        }

        .today::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 2px solid var(--primary-color);
            pointer-events: none;
            animation: todayPulse 2s infinite cubic-bezier(0.4, 0, 0.6, 1);
        }

        @keyframes todayPulse {
            0% { border-color: var(--primary-color); opacity: 1; }
            50% { border-color: var(--primary-light); opacity: 0.6; }
            100% { border-color: var(--primary-color); opacity: 1; }
        }
        
        .edit-mode {
            padding: 0.5rem;
        }
        
        .habit-name-input {
            width: 100%;
            padding: 0.875rem 1.25rem;
            border: 1.5px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            transition: all 0.2s ease;
            background-color: var(--bg-color);
            color: var(--text-color);
            box-shadow: var(--shadow-inner);
        }

        .habit-name-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px var(--primary-light);
        }
        
        .add-habit-btn {
            margin: 0 2.5rem 2rem;
            padding: 0.875rem 1.75rem;
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 500;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
            box-shadow: var(--shadow-button);
            letter-spacing: -0.01em;
        }

        .add-habit-btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: var(--shadow-lg);
            filter: brightness(1.05);
        }

        .add-habit-btn:active {
            transform: translateY(0) scale(0.98);
            filter: brightness(0.95);
            box-shadow: var(--shadow-sm);
        }
        
        .graph-container {
            margin: 3rem 2.5rem;
            padding: 2.5rem;
            border-radius: var(--radius-lg);
            background-color: var(--bg-color);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .graph-container:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg), 0 0 0 1px var(--primary-light);
        }

        .graph-title {
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 2rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.02em;
        }

        .graph-select {
            padding: 0.875rem 1.5rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 0.95rem;
            transition: all 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
            margin-right: 1rem;
            cursor: pointer;
            box-shadow: var(--shadow-sm);
        }

        .graph-select:hover {
            border-color: var(--primary-light);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .graph-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px var(--primary-light);
        }

        .delete-habit {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            transition: all 0.2s ease;
            cursor: pointer;
            font-size: 1.25rem;
            color: #ef4444;
            width: 1.75rem;
            height: 1.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            background-color: transparent;
        }

        .habit-name-container:hover .delete-habit {
            opacity: 0.7;
        }

        .delete-habit:hover {
            opacity: 1 !important;
            background-color: #fee2e2;
            transform: translateY(-50%);
        }

        .note-toolbar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            background-color: var(--bg-color);
            z-index: 10;
            padding-top: 0.5rem;
        }

        .note-toolbar button {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 0.4rem 0.6rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .note-toolbar button:hover {
            background-color: var(--cell-hover-color);
            border-color: var(--primary-light);
            transform: translateY(-1px);
        }

        .note-toolbar button:active {
            transform: translateY(0);
        }

        .note-toolbar button.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .note-toolbar .separator {
            width: 1px;
            height: 24px;
            background-color: var(--border-color);
            margin: 0 0.25rem;
        }

        .note-editor {
            width: 100%;
            height: calc(90vh - 10rem);
            max-height: calc(90vh - 10rem);
            padding: 1.5rem;
            border: 1.5px solid var(--border-color);
            border-radius: var(--radius-sm);
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: all 0.2s ease;
            font-family: inherit;
            line-height: 1.6;
            overflow-y: auto;
            font-size: 1.125rem;
            outline: none; /* Fix for focus outline issues */
        }

        .note-editor:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .note-templates {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .template-btn {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-color);
        }

        .template-btn:hover {
            background-color: var(--cell-hover-color);
            border-color: var(--primary-light);
        }

        .image-preview {
            max-width: 100%;
            max-height: 200px;
            margin: 0.5rem 0;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-color);
        }

        .habit-target {
            display: flex;
            align-items: center;
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-light);
            max-width: 100%; /* Prevent overflow */
            overflow: hidden; /* Prevent overflow */
        }

        .habit-target-bar {
            height: 4px;
            background-color: var(--border-color);
            border-radius: 2px;
            margin: 0 0.5rem;
            flex-grow: 1;
            position: relative;
            overflow: hidden;
            min-width: 50px; /* Ensure minimum width */
        }
        
        .habit-target-progress {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: var(--primary-gradient);
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        .habit-target-label {
            white-space: nowrap;
            overflow: hidden; /* Prevent overflow */
            text-overflow: ellipsis; /* Show ellipsis for overflow */
            max-width: 60px; /* Limit width */
        }

        .habit-has-target::after {
            content: "üéØ";
            position: absolute;
            bottom: 4px;
            right: 4px;
            font-size: 0.8rem;
            opacity: 0.7;
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .note-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary-color);
            flex-grow: 1;
            margin-right: 1rem;
        }

        .note-date {
            font-size: 0.9rem;
            color: var(--text-light);
            white-space: nowrap;
        }

        .note-placeholder {
            color: var(--text-light);
            font-style: italic;
            opacity: 0.7;
        }

        .note-toolbar-group {
            display: flex;
            gap: 0.25rem;
            align-items: center;
        }
        
        .graph-canvas-container {
            height: 300px;
            margin-top: 1.5rem;
            position: relative;
        }
        
        /* Remove all tooltip, ripple effects and other potentially problematic styling */
        
        /* Goal section styling */
        .goal-container {
            background-color: var(--bg-color);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow);
            margin: 1.5rem 2.5rem 1rem;
            padding: 1.5rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }
        
        .goal-text {
            font-size: 1.3rem;
            font-weight: 500;
            color: var(--text-color);
            flex-grow: 1;
            line-height: 1.4;
        }
        
        .goal-emoji {
            font-size: 2rem;
            margin-right: 1rem;
        }
        
        .goal-content {
            display: flex;
            align-items: center;
        }
        
        .add-goal-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            border-radius: var(--radius-sm);
            padding: 0.4rem 1rem;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            margin-left: 1rem;
            transition: all 0.2s ease;
        }
        
        .add-goal-btn:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-1px);
        }
        
        .add-goal-btn:active {
            transform: translateY(0);
        }
        
        .edit-goal-btn, .delete-goal-btn {
            background: transparent;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            padding: 0.25rem;
            margin-left: 0.5rem;
            border-radius: 50%;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
        }
        
        .edit-goal-btn:hover, .delete-goal-btn:hover {
            background-color: var(--light-gray);
            color: var(--text-color);
        }
        
        .goal-placeholder {
            color: var(--text-light);
            font-style: italic;
        }
        
        .goal-actions {
            display: flex;
            align-items: center;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">HabitTracker</div>
        <div class="header-actions">
            <button id="goal-button" class="header-button" title="Set Monthly Goal">üéØ</button>
            <div class="theme-toggle" id="theme-toggle">
                <span id="theme-icon">üåô</span>
            </div>
        </div>
    </header>
    
    <!-- Goal section -->
    <div id="goal-section">
        <!-- Goal will be dynamically generated here -->
    </div>
    
    <div class="month-nav">
        <button class="nav-btn" id="prev-month">‚ùÆ</button>
        <div class="month-display">February, 2025</div>
        <button class="nav-btn" id="next-month">‚ùØ</button>
    </div>
    
    <button class="add-habit-btn" id="add-habit-btn">+ New Habit</button>
    
    <div class="calendar">
        <div class="calendar-inner" id="calendar-table">
            <!-- Calendar content will be generated by JavaScript -->
        </div>
    </div>
    
    <div class="graph-container">
        <div class="graph-title">Habit Completion Trends</div>
        <div class="graph-controls">
            <select id="graph-habit-select" class="graph-select">
                <option value="all">All Habits</option>
                <!-- Habit options will be added dynamically -->
            </select>
            <select id="graph-period-select" class="graph-select">
                <option value="week">Last 7 Days</option>
                <option value="month" selected>Current Month</option>
                <option value="3months">Last 3 Months</option>
            </select>
        </div>
        <div class="graph-canvas-container">
            <canvas id="habit-graph"></canvas>
        </div>
    </div>

    <div id="tooltip" class="tooltip"></div>

    <script>
        // Initialize all variables at the global scope BEFORE any other code
        let habits = [];
        let completedDays = {};
        let habitNotes = {};
        let habitTargets = {};
        let goalData = null;
        let isDarkMode = false;
        let currentDate = new Date(2025, 1, 1); // February 2025
        let habitChart = null;
        let draggedElement = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Date management
            const prevMonthBtn = document.getElementById('prev-month');
            const nextMonthBtn = document.getElementById('next-month');
            const monthDisplay = document.querySelector('.month-display');
            const calendarTable = document.getElementById('calendar-table');
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = document.getElementById('theme-icon');
            const graphHabitSelect = document.getElementById('graph-habit-select');
            const graphPeriodSelect = document.getElementById('graph-period-select');
            const habitGraphCanvas = document.getElementById('habit-graph');
            const goalSection = document.getElementById('goal-section');
            const goalButton = document.getElementById('goal-button');
            
            // Chart instance
            habitChart = null;
            
            // Theme management - get from localStorage
            isDarkMode = localStorage.getItem('dailyHabits_darkMode') === 'true';
            
            // Apply theme based on saved preference
            if (isDarkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
                themeIcon.textContent = '‚òÄÔ∏è';
            } else {
                document.documentElement.removeAttribute('data-theme');
                themeIcon.textContent = 'üåô';
            }
            
            // Theme toggle event
            themeToggle.addEventListener('click', function() {
                isDarkMode = !isDarkMode;
                if (isDarkMode) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    themeIcon.textContent = '‚òÄÔ∏è';
                } else {
                    document.documentElement.removeAttribute('data-theme');
                    themeIcon.textContent = 'üåô';
                }
                localStorage.setItem('dailyHabits_darkMode', isDarkMode);
                updateCalendar();
                updateHabitGraph();
                updateGoalSection();
            });
            
            const months = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            
            const weekdays = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
            
            // Use the existing global variables, don't redeclare them
            currentDate = new Date(2025, 1, 1); // Month is 0-indexed in JS Date
            
            // Load data from localStorage if available
            function loadFromLocalStorage() {
                try {
                    const savedHabits = localStorage.getItem('dailyHabits_habits');
                    const savedCompletedDays = localStorage.getItem('dailyHabits_completedDays');
                    const savedCurrentDate = localStorage.getItem('dailyHabits_currentDate');
                    const savedHabitNotes = localStorage.getItem('dailyHabits_habitNotes');
                    const savedDarkMode = localStorage.getItem('dailyHabits_darkMode');
                    const savedHabitTargets = localStorage.getItem('dailyHabits_habitTargets');
                    const savedGoal = localStorage.getItem('dailyHabits_goal');
                    
                    console.log("Loading from localStorage - Raw data:", {
                        savedHabits, 
                        savedCompletedDays,
                        savedCurrentDate
                    });
                    
                    if (savedHabits) {
                        habits = JSON.parse(savedHabits);
                    }
                    
                    if (savedCompletedDays) {
                        completedDays = JSON.parse(savedCompletedDays);
                        console.log("Loaded completedDays directly:", completedDays);
                    }
                    
                    if (savedCurrentDate) {
                        const dateObj = new Date(savedCurrentDate);
                        // Only use saved date if it's valid
                        if (!isNaN(dateObj.getTime())) {
                            currentDate = dateObj;
                        }
                    }
                    
                    if (savedHabitNotes) {
                        habitNotes = JSON.parse(savedHabitNotes);
                    }
                    
                    if (savedHabitTargets) {
                        habitTargets = JSON.parse(savedHabitTargets);
                    }
                    
                    if (savedGoal) {
                        goalData = JSON.parse(savedGoal);
                    }
                    
                    if (savedDarkMode) {
                        isDarkMode = savedDarkMode === 'true';
                        if (isDarkMode) {
                            document.documentElement.setAttribute('data-theme', 'dark');
                            themeIcon.textContent = '‚òÄÔ∏è';
                        }
                    }
                } catch (e) {
                    console.error("Error loading from localStorage:", e);
                    
                    // Initialize with empty data structures if there was an error
                    habits = habits || [];
                    completedDays = completedDays || {};
                    habitNotes = habitNotes || {};
                    habitTargets = habitTargets || {};
                }
            }
            
            // Add a debug function to clear storage - this is just for testing
            function clearAllStorage() {
                localStorage.removeItem('dailyHabits_habits');
                localStorage.removeItem('dailyHabits_completedDays');
                localStorage.removeItem('dailyHabits_currentDate');
                localStorage.removeItem('dailyHabits_habitNotes');
                localStorage.removeItem('dailyHabits_habitTargets');
                localStorage.removeItem('dailyHabits_goal');
                localStorage.removeItem('dailyHabits_darkMode');
                console.log("All localStorage items cleared");
            }
            
            // Ensure localStorage is working properly
            function testLocalStorage() {
                try {
                    // Check if we're in private browsing mode
                    console.log("STORAGE TEST - Starting localStorage test");
                    
                    // Test if localStorage is writeable
                    localStorage.setItem('testKey', 'testValue');
                    // Test if localStorage is readable
                    const testValue = localStorage.getItem('testKey');
                    // Test if localStorage is deletable
                    localStorage.removeItem('testKey');
                    
                    // Test if we can save and reload an object
                    const testObj = { test: "true" };
                    localStorage.setItem('testObject', JSON.stringify(testObj));
                    const testObjValue = JSON.parse(localStorage.getItem('testObject') || "{}");
                    localStorage.removeItem('testObject');
                    
                    const isAvailable = testValue === 'testValue' && testObjValue.test === "true";
                    console.log(`STORAGE TEST - localStorage availability: ${isAvailable ? "WORKING" : "NOT WORKING"}`);
                    
                    if (isAvailable) {
                        // Display visible notification for user
                        console.log('STORAGE TEST - localStorage is working properly');
                        return true;
                    } else {
                        // Display visible error for user
                        alert('localStorage test failed - data will not persist!');
                        return false;
                    }
                } catch (e) {
                    console.error('STORAGE TEST - localStorage test error:', e);
                    
                    // Display visible error for user
                    alert('localStorage error: ' + e.message + '\nYour changes will not be saved. Please try using a normal browsing session instead of private/incognito mode.');
                    
                    return false;
                }
            }
            
            // Run localStorage test during initialization
            testLocalStorage();
            
            // Load data from localStorage
            loadFromLocalStorage();
            
            // Save data to localStorage with retry mechanism
            function saveToLocalStorage() {
                try {
                    // Log the completedDays values to make sure they're as expected
                    console.log("About to save completedDays (raw object):", completedDays);
                    
                    // No conversion needed since we're now storing "true"/"false" strings directly
                    
                    // Save all data
                    localStorage.setItem('dailyHabits_habits', JSON.stringify(habits));
                    localStorage.setItem('dailyHabits_completedDays', JSON.stringify(completedDays));
                    localStorage.setItem('dailyHabits_currentDate', currentDate.toISOString());
                    localStorage.setItem('dailyHabits_habitNotes', JSON.stringify(habitNotes));
                    localStorage.setItem('dailyHabits_habitTargets', JSON.stringify(habitTargets));
                    localStorage.setItem('dailyHabits_goal', JSON.stringify(goalData));
                    localStorage.setItem('dailyHabits_darkMode', isDarkMode);
                    
                    // Verify data was saved correctly
                    const savedCompletedDays = localStorage.getItem('dailyHabits_completedDays');
                    console.log("Verification - Saved completedDays:", savedCompletedDays);
                    
                    return true;
                } catch (e) {
                    console.error("Error saving to localStorage:", e);
                    
                    // Try one more time after a small delay
                    setTimeout(() => {
                        try {
                            localStorage.setItem('dailyHabits_habits', JSON.stringify(habits));
                            localStorage.setItem('dailyHabits_completedDays', JSON.stringify(completedDays));
                            localStorage.setItem('dailyHabits_currentDate', currentDate.toISOString());
                            localStorage.setItem('dailyHabits_habitNotes', JSON.stringify(habitNotes));
                            localStorage.setItem('dailyHabits_habitTargets', JSON.stringify(habitTargets));
                            localStorage.setItem('dailyHabits_goal', JSON.stringify(goalData));
                            localStorage.setItem('dailyHabits_darkMode', isDarkMode);
                            console.log("Retry successful");
                        } catch (retryError) {
                            console.error("Retry failed:", retryError);
                        }
                    }, 500);
                    
                    return false;
                }
            }
            
            // Function to get days in month
            function getDaysInMonth(year, month) {
                return new Date(year, month + 1, 0).getDate();
            }
            
            // Function to update calendar headers and days based on current month/year
            function updateCalendar() {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const today = new Date(); // Define today at the start
                
                // Update month/year display with animation
                const oldText = monthDisplay.textContent;
                const newText = `${months[month]}, ${year}`;
                
                if (oldText !== newText) {
                    monthDisplay.style.opacity = '0';
                    monthDisplay.style.transform = 'translateY(-10px)';
                    
                    setTimeout(() => {
                        monthDisplay.textContent = newText;
                        monthDisplay.style.opacity = '1';
                        monthDisplay.style.transform = 'translateY(0)';
                    }, 200);
                } else {
                    monthDisplay.textContent = newText;
                }
                
                // Clear existing calendar content
                calendarTable.innerHTML = '';
                
                // Create header row with weekday names and dates
                const headerRow = document.createElement('div');
                headerRow.className = 'calendar-header';
                
                // Calculate first day of month (0 = Sunday, 1 = Monday, etc.)
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                // Calculate days in month
                const daysInMonth = getDaysInMonth(year, month);
                
                // Add empty cell for habit names column
                const emptyHeaderCell = document.createElement('div');
                emptyHeaderCell.className = 'header-cell';
                emptyHeaderCell.textContent = 'Habits';
                if (firstDayOfMonth === 1) { // 1 is Monday
                    emptyHeaderCell.classList.add('week-start');
                }
                
                headerRow.appendChild(emptyHeaderCell);
                
                // Add combined day headers with heat map
                for (let i = 0; i < daysInMonth; i++) {
                    const dayDate = new Date(year, month, i + 1);
                    const weekdayIndex = dayDate.getDay();
                    const dayNumber = i + 1;
                    const isToday = today.getMonth() === month && 
                                   today.getFullYear() === year && 
                                   today.getDate() === dayNumber;
                    
                    // Week grouping logic
                    const isMonday = weekdayIndex === 1;
                    const isSunday = weekdayIndex === 0;
                    const isFirstDay = i === 0;
                    const isLastDay = i === daysInMonth - 1;
                    
                    // Count completed habits for heat map
                    let completedCount = 0;
                    let totalHabits = habits.length;
                    
                    habits.forEach(habit => {
                        const dateKey = `${year}-${month}-${dayNumber}-${habit.type}`;
                        if (completedDays[dateKey] === true) {
                            completedCount++;
                        }
                    });
                    
                    // Calculate heat level
                    let backgroundColor = 'transparent';
                    if (totalHabits > 0) {
                        const completionRate = completedCount / totalHabits;
                        
                        if (completionRate > 0) {
                            // Use HSL for smooth color transition with different values for dark mode
                            let hue, saturation, lightness, opacity;
                            
                            if (isDarkMode) {
                                // Dark mode heat map colors - more subdued and natural
                                if (completionRate <= 0.5) {
                                    // Deep purple (260) to blue (210)
                                    hue = 260 - (completionRate * 2 * 50);
                                    lightness = 40 + (completionRate * 15); // 40-55% lightness
                                    saturation = 70 - (completionRate * 10); // Slightly desaturate
                                } else {
                                    // Blue (210) to teal (180)
                                    hue = 210 - (completionRate - 0.5) * 2 * 30;
                                    lightness = 55 - ((completionRate - 0.5) * 10); // Slightly darker
                                    saturation = 60 + ((completionRate - 0.5) * 20); // More saturated
                                }
                                // Opacity increases with completion but stays subtle
                                opacity = 0.4 + (completionRate * 0.4);
                            } else {
                                // Light mode heat map colors - original
                                if (completionRate <= 0.5) {
                                    // Red (0) to Yellow (60)
                                    hue = completionRate * 2 * 60;
                                    // Start with lighter red and transition to yellow
                                    lightness = 55 + (completionRate * 10); // 55-60% lightness
                                    saturation = 85 - (completionRate * 10); // Slightly desaturate towards yellow
                                } else {
                                    // Yellow (60) to Highlighter Green (95)
                                    hue = 60 + (completionRate - 0.5) * 2 * 35; // Max hue 95 instead of 120
                                    lightness = 60 - ((completionRate - 0.5) * 15); // Slightly darker for green
                                    saturation = 75 + ((completionRate - 0.5) * 20); // More saturated for green
                                }
                                // Opacity increases with completion but stays subtle
                                opacity = 0.35 + (completionRate * 0.45);
                            }
                            
                            backgroundColor = `hsla(${hue}, ${saturation}%, ${lightness}%, ${opacity})`;
                        } else {
                            // No completion color
                            if (isDarkMode) {
                                backgroundColor = 'hsla(350, 60%, 40%, 0.35)'; // Darker, more subdued red for dark mode
                            } else {
                                backgroundColor = 'hsla(0, 85%, 55%, 0.35)'; // Original light mode red
                            }
                        }
                    }
                    
                    const headerCell = document.createElement('div');
                    headerCell.className = `header-cell day-cell${isToday ? ' today' : ''}`;
                    
                    // Only add week-start if it's Monday or first day of month that's not in middle of week
                    if (isMonday || (isFirstDay && firstDayOfMonth === 1)) {
                        headerCell.classList.add('week-start');
                    }
                    // Only add week-end if it's Sunday and not the last day
                    if (isSunday && !isLastDay) {
                        headerCell.classList.add('week-end');
                    }
                    headerCell.style.backgroundColor = backgroundColor;
                    
                    // Add weekday
                    const weekdayDiv = document.createElement('div');
                    weekdayDiv.className = 'weekday';
                    weekdayDiv.textContent = weekdays[weekdayIndex];
                    headerCell.appendChild(weekdayDiv);
                    
                    // Add date
                    const dateDiv = document.createElement('div');
                    dateDiv.className = 'date';
                    dateDiv.textContent = dayNumber;
                    headerCell.appendChild(dateDiv);
                    
                    headerRow.appendChild(headerCell);
                }
                
                calendarTable.appendChild(headerRow);
                
                // Create a row for each habit
                habits.forEach((habit, index) => {
                    const habitRow = document.createElement('div');
                    habitRow.className = 'habit-row';
                    habitRow.setAttribute('data-habit-type', habit.type);
                    habitRow.setAttribute('draggable', 'true');
                    
                    // Setup drag events for reordering
                    setupDragEvents(habitRow);
                    
                    // Add habit name cell with delete button
                    const habitNameContainer = document.createElement('div');
                    habitNameContainer.className = 'habit-name-container';
                    if (firstDayOfMonth === 1) {
                        habitNameContainer.classList.add('week-start');
                    }
                    
                    const habitNameElement = document.createElement('div');
                    habitNameElement.className = 'habit-name';
                    habitNameElement.setAttribute('data-editable', 'true');
                    habitNameElement.textContent = habit.name;
                    habitNameContainer.appendChild(habitNameElement);
                    
                    // Add target indicator if habit has a target
                    if (habitTargets[habit.type]) {
                        const targetData = habitTargets[habit.type];
                        const currentMonth = `${year}-${month}`;
                        
                        // Count completed days in current month
                        let completedCount = 0;
                        for (let i = 1; i <= daysInMonth; i++) {
                            const dateKey = `${year}-${month}-${i}-${habit.type}`;
                            if (completedDays[dateKey] === true) {
                                completedCount++;
                            }
                        }
                        
                        // Calculate progress percentage
                        const progressPercent = Math.min(100, (completedCount / targetData.target) * 100);
                        
                        // Create target progress bar
                        const targetBar = document.createElement('div');
                        targetBar.className = 'habit-target';
                        
                        const targetBarInner = document.createElement('div');
                        targetBarInner.className = 'habit-target-bar';
                        
                        const targetProgress = document.createElement('div');
                        targetProgress.className = 'habit-target-progress';
                        targetProgress.style.width = `${progressPercent}%`;
                        
                        const targetLabel = document.createElement('div');
                        targetLabel.className = 'habit-target-label';
                        targetLabel.textContent = `${completedCount}/${targetData.target}`;
                        
                        targetBarInner.appendChild(targetProgress);
                        targetBar.appendChild(targetBarInner);
                        targetBar.appendChild(targetLabel);
                        
                        habitNameContainer.appendChild(targetBar);
                    }
                    
                    // Add delete button
                    const deleteButton = document.createElement('span');
                    deleteButton.className = 'delete-habit';
                    deleteButton.innerHTML = '√ó';
                    deleteButton.setAttribute('title', 'Delete habit');
                    deleteButton.addEventListener('click', function(e) {
                        e.stopPropagation();
                        if (confirm(`Are you sure you want to delete "${habit.name}"?`)) {
                            const index = habits.findIndex(h => h.type === habit.type);
                            if (index !== -1) {
                                habits.splice(index, 1);
                                Object.keys(completedDays).forEach(key => {
                                    if (key.includes(`-${habit.type}`)) {
                                        delete completedDays[key];
                                    }
                                });
                                Object.keys(habitNotes).forEach(key => {
                                    if (key.includes(`-${habit.type}`)) {
                                        delete habitNotes[key];
                                    }
                                });
                                saveToLocalStorage();
                                updateCalendar();
                                updateHabitGraph();
                            }
                        }
                    });
                    habitNameContainer.appendChild(deleteButton);
                    
                    habitRow.appendChild(habitNameContainer);
                    
                    // Add cells for each day
                    for (let i = 0; i < daysInMonth; i++) {
                        const dayNumber = i + 1;
                        const dateKey = `${year}-${month}-${dayNumber}-${habit.type}`;
                        
                        const habitCell = document.createElement('div');
                        habitCell.className = `habit-cell ${habit.type}-cell day-cell`;
                        if (habit.type.startsWith('custom-')) {
                            const customIndex = (index % 10) + 1;  // Cycle through 10 colors instead of 5
                            habitCell.classList.add(`custom-cell-${customIndex}`);
                        }
                        habitCell.setAttribute('data-date', dateKey);
                        
                        // Explicitly check for the string "true" value
                        if (completedDays[dateKey] === "true") {
                            habitCell.classList.add('completed');
                            console.log(`Cell ${dateKey} marked as completed from saved data`);
                        } else if (completedDays[dateKey] === "crossed" || completedDays[dateKey] === "false") {
                            // For backward compatibility check both crossed and false
                            if (completedDays[dateKey] === "crossed") {
                                habitCell.classList.add('crossed');
                                console.log(`Cell ${dateKey} marked as crossed from saved data`);
                            }
                        }
                        
                        if (habitNotes[dateKey]) {
                            habitCell.classList.add('has-note');
                            habitCell.setAttribute('title', 'Double-click to view/edit note');
                        }
                        
                        // Inside the habit cells creation loop, update week grouping classes
                        const dayDate = new Date(year, month, dayNumber);
                        const weekdayIndex = dayDate.getDay();
                        const isMonday = weekdayIndex === 1;
                        const isSunday = weekdayIndex === 0;
                        const isFirstDay = dayNumber === 1;
                        const isLastDay = dayNumber === daysInMonth;

                        // Add week grouping classes without overwriting existing ones
                        if (isMonday || (isFirstDay && firstDayOfMonth === 1)) {
                            habitCell.classList.add('week-start');
                        }
                        if (isSunday && !isLastDay) {
                            habitCell.classList.add('week-end');
                        }
                        
                        // Click handling
                        let clickTimer = null;
                        let isDoubleClick = false;
                        
                        habitCell.addEventListener('click', function(e) {
                            if (isDoubleClick) {
                                isDoubleClick = false;
                                return;
                            }
                            
                            clearTimeout(clickTimer);
                            clickTimer = setTimeout(() => {
                                const dateKey = this.getAttribute('data-date');
                                enhancedHabitCellClick(this, dateKey);
                            }, 250);
                        });
                        
                        habitCell.addEventListener('contextmenu', function(e) {
                            e.preventDefault();
                            clearTimeout(clickTimer);
                            
                            console.log("CONTEXT - Starting context menu handler");
                            
                            const dateKey = this.getAttribute('data-date');
                            console.log("CONTEXT - Handling context menu for:", dateKey);
                            console.log("CONTEXT - Current localStorage state:", localStorage.getItem('dailyHabits_completedDays'));
                            
                            if (this.classList.contains('crossed')) {
                                this.classList.remove('crossed');
                                // Store as STRING, not boolean
                                completedDays[dateKey] = "false";
                                console.log(`CONTEXT - Removed crossed from ${dateKey}, set to "false"`);
                            } else {
                                this.classList.remove('completed');
                                this.classList.add('crossed');
                                // Store as STRING, not boolean
                                completedDays[dateKey] = "false";
                                console.log(`CONTEXT - Added crossed to ${dateKey}, set to "false"`);
                            }
                            
                            // Update heat map for this day
                            updateHeatMapForDay(parseInt(year), parseInt(month), parseInt(dayNumber));
                            
                            // Update target bars in real-time
                            updateTargetBars();
                            
                            // Make sure we're saving immediately
                            const saveSuccess = saveToLocalStorage();
                            console.log(`CONTEXT - Saved to localStorage: ${saveSuccess}`);
                            
                            // Make multiple verification attempts to ensure data is properly saved
                            const verifyData = () => {
                                const savedData = localStorage.getItem('dailyHabits_completedDays');
                                if (savedData) {
                                    const parsed = JSON.parse(savedData);
                                    console.log(`CONTEXT - Verification check - Is ${dateKey} marked correctly:`, parsed[dateKey]);
                                    console.log(`CONTEXT - Full completedDays object in localStorage:`, savedData);
                                    
                                    // If the data doesn't match what we expect, try saving again
                                    const expectedValue = "false"; // Context menu always sets to "false" string
                                    if (parsed[dateKey] !== expectedValue) {
                                        console.log(`CONTEXT - Data mismatch! Expected ${expectedValue} but got ${parsed[dateKey]}. Trying to save again...`);
                                        saveToLocalStorage();
                                    }
                                } else {
                                    console.error("CONTEXT - No saved data found in verification!");
                                    // Try to save again
                                    saveToLocalStorage();
                                }
                            };
                            
                            // Verify multiple times with increasing delays
                            setTimeout(verifyData, 100);
                            setTimeout(verifyData, 500);
                            setTimeout(verifyData, 1000);
                            
                            updateHabitGraph();
                        });
                        
                        habitCell.addEventListener('dblclick', function(e) {
                            e.stopPropagation();
                            e.preventDefault();
                            isDoubleClick = true;
                            clearTimeout(clickTimer);
                            showNoteEditor(dateKey, this);
                        });
                        
                        habitRow.appendChild(habitCell);
                    }
                    
                    calendarTable.appendChild(habitRow);
                });
                
                setupEditableHabitNames();
                updateGraphHabitSelect();
                updateHabitGraph();
                saveToLocalStorage();
            }
            
            // Function to show note editor with enhanced animations
            function showNoteEditor(dateKey, cell) {
                // Remove any existing note editors and overlays
                const existingNotes = document.querySelectorAll('.habit-note, .note-overlay');
                existingNotes.forEach(note => note.remove());
                
                // Parse the dateKey to get date information
                const [year, month, day, habitType] = dateKey.split('-');
                const dateObj = new Date(parseInt(year), parseInt(month), parseInt(day));
                
                // Find the habit name
                const habit = habits.find(h => h.type === habitType);
                const habitName = habit ? habit.name : 'Unknown Habit';
                
                // Format the date for display
                const formattedDate = dateObj.toLocaleDateString(undefined, { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                // Create overlay
                const overlay = document.createElement('div');
                overlay.className = 'note-overlay';
                document.body.appendChild(overlay);
                
                // Create note container
                const noteContainer = document.createElement('div');
                noteContainer.className = 'habit-note';
                
                // Create note header
                const noteHeader = document.createElement('div');
                noteHeader.className = 'note-header';
                
                const noteTitle = document.createElement('div');
                noteTitle.className = 'note-title';
                noteTitle.textContent = habitName;
                
                const noteDate = document.createElement('div');
                noteDate.className = 'note-date';
                noteDate.textContent = formattedDate;
                
                noteHeader.appendChild(noteTitle);
                noteHeader.appendChild(noteDate);
                
                // Create toolbar
                const toolbar = document.createElement('div');
                toolbar.className = 'note-toolbar';
                
                // Text formatting group
                const textFormatGroup = document.createElement('div');
                textFormatGroup.className = 'note-toolbar-group';
                
                const formatButtons = [
                    { command: 'bold', icon: '<b>B</b>', title: 'Bold (Ctrl+B)' },
                    { command: 'italic', icon: '<i>I</i>', title: 'Italic (Ctrl+I)' },
                    { command: 'underline', icon: '<u>U</u>', title: 'Underline (Ctrl+U)' }
                ];
                
                formatButtons.forEach(btn => {
                    const button = document.createElement('button');
                    button.innerHTML = btn.icon;
                    button.title = btn.title;
                    button.addEventListener('click', () => {
                        document.execCommand(btn.command, false);
                        noteEditor.focus();
                    });
                    textFormatGroup.appendChild(button);
                });
                
                toolbar.appendChild(textFormatGroup);
                
                // Add separator
                const separator1 = document.createElement('div');
                separator1.className = 'separator';
                toolbar.appendChild(separator1);
                
                // Paragraph formatting group
                const paraFormatGroup = document.createElement('div');
                paraFormatGroup.className = 'note-toolbar-group';
                
                const headingButtons = [
                    { command: 'formatBlock', value: 'H1', icon: 'H1', title: 'Heading 1' },
                    { command: 'formatBlock', value: 'H3', icon: 'H3', title: 'Heading 3' }
                ];
                
                headingButtons.forEach(btn => {
                    const button = document.createElement('button');
                    button.textContent = btn.icon;
                    button.title = btn.title;
                    button.addEventListener('click', () => {
                        document.execCommand(btn.command, false, btn.value);
                        noteEditor.focus();
                    });
                    paraFormatGroup.appendChild(button);
                });
                
                toolbar.appendChild(paraFormatGroup);
                
                // Add separator
                const separator2 = document.createElement('div');
                separator2.className = 'separator';
                toolbar.appendChild(separator2);
                
                // List formatting group
                const listFormatGroup = document.createElement('div');
                listFormatGroup.className = 'note-toolbar-group';
                
                const listButtons = [
                    { command: 'insertUnorderedList', icon: '‚Ä¢ List', title: 'Bullet List' },
                    { command: 'insertOrderedList', icon: '1. List', title: 'Numbered List' }
                ];
                
                listButtons.forEach(btn => {
                    const button = document.createElement('button');
                    button.textContent = btn.icon;
                    button.title = btn.title;
                    button.addEventListener('click', () => {
                        document.execCommand(btn.command, false);
                        noteEditor.focus();
                    });
                    listFormatGroup.appendChild(button);
                });
                
                toolbar.appendChild(listFormatGroup);
                
                // Add separator
                const separator3 = document.createElement('div');
                separator3.className = 'separator';
                toolbar.appendChild(separator3);
                
                // Add image upload button
                const imageBtn = document.createElement('button');
                imageBtn.innerHTML = 'üì∑';
                imageBtn.title = 'Insert Image';
                
                const imageInput = document.createElement('input');
                imageInput.type = 'file';
                imageInput.accept = 'image/*';
                imageInput.style.display = 'none';
                
                imageBtn.addEventListener('click', () => {
                    imageInput.click();
                });
                
                imageInput.addEventListener('change', function() {
                    if (this.files && this.files[0]) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.className = 'image-preview';
                            img.style.maxWidth = '100%'; // Ensure image fits in editor
                            img.style.height = 'auto'; // Maintain aspect ratio
                            document.execCommand('insertHTML', false, img.outerHTML);
                        };
                        reader.readAsDataURL(this.files[0]);
                    }
                });
                
                toolbar.appendChild(imageBtn);
                noteContainer.appendChild(imageInput);
                
                // Create rich text editor
                const noteEditor = document.createElement('div');
                noteEditor.className = 'note-editor';
                noteEditor.contentEditable = true;
                
                // Add placeholder text
                if (!habitNotes[dateKey] || habitNotes[dateKey].trim() === '') {
                    noteEditor.innerHTML = '<div class="note-placeholder">Write your notes here...</div>';
                    noteEditor.addEventListener('focus', function() {
                        if (this.querySelector('.note-placeholder')) {
                            this.innerHTML = '';
                        }
                    });
                } else {
                    noteEditor.innerHTML = habitNotes[dateKey];
                }
                
                // Create action buttons
                const actions = document.createElement('div');
                actions.className = 'note-actions';
                
                const saveButton = document.createElement('button');
                saveButton.className = 'note-btn note-save';
                saveButton.textContent = 'Save';
                
                const cancelButton = document.createElement('button');
                cancelButton.className = 'note-btn note-cancel';
                cancelButton.textContent = 'Cancel';
                
                actions.appendChild(cancelButton);
                actions.appendChild(saveButton);
                
                // Add components to container
                noteContainer.appendChild(noteHeader);
                noteContainer.appendChild(toolbar);
                noteContainer.appendChild(noteEditor);
                noteContainer.appendChild(actions);
                
                // Add to document
                document.body.appendChild(noteContainer);
                
                // Save note function
                function saveNote() {
                    let value = noteEditor.innerHTML.trim();
                    
                    // Check if it's just the placeholder or empty
                    if (value === '<div class="note-placeholder">Write your notes here...</div>' || 
                        value === '' || value === '<br>' || value === '<div><br></div>') {
                        delete habitNotes[dateKey];
                        cell.classList.remove('has-note');
                        cell.removeAttribute('title');
                    } else {
                        habitNotes[dateKey] = value;
                        cell.classList.add('has-note');
                        cell.setAttribute('title', 'Double-click to view/edit note');
                    }
                    saveToLocalStorage();
                    closeNote();
                }
                
                // Close note function
                function closeNote() {
                    noteContainer.remove();
                    overlay.remove();
                }
                
                // Add event listeners
                saveButton.addEventListener('click', saveNote);
                cancelButton.addEventListener('click', closeNote);
                overlay.addEventListener('click', closeNote);
                
                // Handle keyboard shortcuts
                noteEditor.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        saveNote();
                    } else if (e.key === 'Escape') {
                        closeNote();
                    }
                });
                
                // Focus the editor with improved cursor positioning
                setTimeout(() => {
                    noteEditor.focus();
                    // Place cursor at the end if there's content
                    if (habitNotes[dateKey] && !noteEditor.querySelector('.note-placeholder')) {
                        // Create a proper range at the end of the content
                        const range = document.createRange();
                        const sel = window.getSelection();
                        
                        // Find the last text node or element
                        let lastNode = noteEditor.lastChild;
                        if (!lastNode) {
                            // If empty, just put cursor at beginning
                            range.setStart(noteEditor, 0);
                            range.collapse(true);
                        } else {
                            // If the last node is an element (like a div or p)
                            if (lastNode.nodeType === 1) {
                                // If it has child nodes, go to the last one
                                if (lastNode.lastChild) {
                                    lastNode = lastNode.lastChild;
                                }
                            }
                            
                            // If it's a text node, put cursor at the end
                            if (lastNode.nodeType === 3) {
                                range.setStart(lastNode, lastNode.length);
                                range.collapse(true);
                            } else {
                                // Otherwise, append after the element
                                range.setStartAfter(lastNode);
                                range.collapse(true);
                            }
                        }
                        
                        sel.removeAllRanges();
                        sel.addRange(range);
                    }
                }, 0);
            }
            
            // Function to make habit names editable
            function setupEditableHabitNames() {
                const habitNames = document.querySelectorAll('.habit-name[data-editable="true"]');
                
                habitNames.forEach(habitName => {
                    // Remove existing event listener to prevent duplicates
                    habitName.removeEventListener('click', handleHabitNameClick);
                    // Add click event listener
                    habitName.addEventListener('click', handleHabitNameClick);
                });
            }
            
            function handleHabitNameClick(e) {
                e.stopPropagation();
                
                const habitName = e.target;
                const currentText = habitName.textContent;
                const habitRow = habitName.closest('.habit-row');
                const habitType = habitRow.getAttribute('data-habit-type');
                
                // Create overlay and modal
                const overlay = document.createElement('div');
                overlay.className = 'note-overlay';
                
                const modal = document.createElement('div');
                modal.className = 'habit-note';
                modal.style.width = '400px';
                modal.style.top = '50%';
                modal.style.left = '50%';
                modal.style.transform = 'translate(-50%, -50%)';
                
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'habit-name-input';
                input.value = currentText;
                input.maxLength = 50;
                
                // Add target input
                const targetContainer = document.createElement('div');
                targetContainer.style.marginTop = '1rem';
                
                const targetLabel = document.createElement('label');
                targetLabel.textContent = 'Monthly Target (days):';
                targetLabel.style.display = 'block';
                targetLabel.style.marginBottom = '0.5rem';
                targetLabel.style.fontWeight = '500';
                
                const targetInput = document.createElement('input');
                targetInput.type = 'number';
                targetInput.min = '1';
                targetInput.max = '31';
                targetInput.className = 'habit-name-input';
                targetInput.placeholder = 'e.g., 20 days per month';
                
                // Track initial state for comparison
                const initialHasTarget = habitTargets[habitType] ? true : false;
                const initialTargetValue = habitTargets[habitType] ? habitTargets[habitType].target : '';
                
                // Set current target if exists
                if (habitTargets[habitType]) {
                    targetInput.value = habitTargets[habitType].target;
                }
                
                // Add target toggle
                const targetToggleContainer = document.createElement('div');
                targetToggleContainer.style.marginTop = '1rem';
                targetToggleContainer.style.display = 'flex';
                targetToggleContainer.style.alignItems = 'center';
                
                const targetToggleLabel = document.createElement('label');
                targetToggleLabel.textContent = 'Enable monthly target:';
                targetToggleLabel.style.marginRight = '1rem';
                targetToggleLabel.style.fontWeight = '500';
                
                const targetToggle = document.createElement('input');
                targetToggle.type = 'checkbox';
                targetToggle.checked = habitTargets[habitType] ? true : false;
                targetToggle.style.width = '18px';
                targetToggle.style.height = '18px';
                
                // Toggle target input visibility based on checkbox
                targetToggle.addEventListener('change', function() {
                    targetInput.disabled = !this.checked;
                    targetInput.style.opacity = this.checked ? '1' : '0.5';
                    if (!this.checked) {
                        targetInput.value = '';
                    }
                    
                    // Update save button state - always enable if toggle state changed
                    const nameChanged = input.value.trim() !== currentText;
                    const targetToggleChanged = this.checked !== initialHasTarget;
                    const targetValueChanged = this.checked && targetInput.value !== initialTargetValue;
                    
                    saveButton.disabled = !(nameChanged || targetToggleChanged || targetValueChanged);
                });
                
                // Initialize target input state
                targetInput.disabled = !targetToggle.checked;
                targetInput.style.opacity = targetToggle.checked ? '1' : '0.5';
                
                targetToggleContainer.appendChild(targetToggleLabel);
                targetToggleContainer.appendChild(targetToggle);
                
                targetContainer.appendChild(targetToggleContainer);
                targetContainer.appendChild(document.createElement('br'));
                targetContainer.appendChild(targetLabel);
                targetContainer.appendChild(targetInput);
                
                const actions = document.createElement('div');
                actions.className = 'note-actions';
                
                const saveButton = document.createElement('button');
                saveButton.className = 'note-btn note-save';
                saveButton.textContent = 'Save';
                saveButton.disabled = true;
                
                const cancelButton = document.createElement('button');
                cancelButton.className = 'note-btn note-cancel';
                cancelButton.textContent = 'Cancel';
                
                actions.appendChild(cancelButton);
                actions.appendChild(saveButton);
                
                modal.appendChild(input);
                modal.appendChild(targetContainer);
                modal.appendChild(actions);
                
                // Add to document
                document.body.appendChild(overlay);
                document.body.appendChild(modal);
                
                // Focus and select input
                input.focus();
                input.select();
                
                // Enable/disable save button based on input
                input.addEventListener('input', function() {
                    const nameChanged = this.value.trim() !== currentText;
                    const targetToggleChanged = targetToggle.checked !== initialHasTarget;
                    const targetValueChanged = targetToggle.checked && targetInput.value !== initialTargetValue;
                    
                    saveButton.disabled = !(nameChanged || targetToggleChanged || targetValueChanged);
                });
                
                targetInput.addEventListener('input', function() {
                    const nameChanged = input.value.trim() !== currentText;
                    const targetToggleChanged = targetToggle.checked !== initialHasTarget;
                    const targetValueChanged = targetToggle.checked && this.value !== initialTargetValue;
                    
                    saveButton.disabled = !(nameChanged || targetToggleChanged || targetValueChanged);
                });
                
                function closeModal() {
                    modal.remove();
                    overlay.remove();
                }
                
                function saveHabitName() {
                    const newHabitName = input.value.trim();
                    const targetValue = parseInt(targetInput.value);
                    const targetEnabled = targetToggle.checked;
                    
                    let updated = false;
                    
                    if (newHabitName && newHabitName !== currentText) {
                        habitName.textContent = newHabitName;
                        
                        // Update habit name in the habits array
                        const habitIndex = habits.findIndex(h => h.type === habitType);
                        if (habitIndex !== -1) {
                            habits[habitIndex].name = newHabitName;
                            updated = true;
                        }
                    }
                    
                    // Update target if enabled and provided
                    if (targetEnabled && !isNaN(targetValue) && targetValue > 0) {
                        habitTargets[habitType] = {
                            target: targetValue
                        };
                        updated = true;
                    } else if (!targetEnabled && habitTargets[habitType]) {
                        // Remove target if disabled
                        delete habitTargets[habitType];
                        updated = true;
                    }
                    
                    if (updated) {
                        saveToLocalStorage();
                        updateCalendar();
                        updateHabitGraph();
                    }
                    
                    closeModal();
                }
                
                // Add event listeners
                saveButton.addEventListener('click', saveHabitName);
                cancelButton.addEventListener('click', closeModal);
                overlay.addEventListener('click', closeModal);
                
                // Handle Enter and Escape keys
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !saveButton.disabled) {
                        saveHabitName();
                    } else if (e.key === 'Escape') {
                        closeModal();
                    }
                });
                
                targetInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !saveButton.disabled) {
                        saveHabitName();
                    } else if (e.key === 'Escape') {
                        closeModal();
                    }
                });
            }
            
            // Setup drag and drop for habit reordering
            function setupDragEvents(habitRow) {
                habitRow.addEventListener('dragstart', function(e) {
                    draggedElement = this;
                    setTimeout(() => {
                        this.classList.add('dragging');
                    }, 0);
                });
                
                habitRow.addEventListener('dragend', function() {
                    this.classList.remove('dragging');
                    draggedElement = null;
                });
                
                habitRow.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    if (draggedElement !== this) {
                        this.classList.add('drag-over');
                    }
                });
                
                habitRow.addEventListener('dragleave', function() {
                    this.classList.remove('drag-over');
                });
                
                habitRow.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('drag-over');
                    
                    if (draggedElement !== this) {
                        // Get the indices of the dragged and target habits
                        const draggedType = draggedElement.getAttribute('data-habit-type');
                        const targetType = this.getAttribute('data-habit-type');
                        
                        const draggedIndex = habits.findIndex(h => h.type === draggedType);
                        const targetIndex = habits.findIndex(h => h.type === targetType);
                        
                        if (draggedIndex !== -1 && targetIndex !== -1) {
                            // Reorder in the habits array
                            const [movedHabit] = habits.splice(draggedIndex, 1);
                            habits.splice(targetIndex, 0, movedHabit);
                            
                            // Save to localStorage after reordering
                            saveToLocalStorage();
                            
                            // Update the UI
                            updateCalendar();
                            updateHabitGraph(); // Update graph after reordering habits
                        }
                    }
                });
                
                // Add mousedown/touchstart for long press detection on mobile
                let pressTimer;
                let isDragging = false;
                
                habitRow.addEventListener('mousedown', function(e) {
                    if (e.target.classList.contains('habit-name') || 
                        e.target.classList.contains('delete-habit')) {
                        return; // Don't start drag if clicking on editable name or delete button
                    }
                    
                    pressTimer = setTimeout(() => {
                        isDragging = true;
                        // Visual feedback that we're dragging
                        this.classList.add('dragging');
                    }, 500); // Long press threshold
                });
                
                habitRow.addEventListener('mousemove', function(e) {
                    if (isDragging) {
                        // Handle manual dragging here if needed
                    }
                });
                
                habitRow.addEventListener('mouseup', function() {
                    clearTimeout(pressTimer);
                    if (isDragging) {
                        this.classList.remove('dragging');
                        isDragging = false;
                    }
                });
                
                habitRow.addEventListener('mouseleave', function() {
                    clearTimeout(pressTimer);
                    if (isDragging) {
                        this.classList.remove('dragging');
                        isDragging = false;
                    }
                });
            }
            
            // Function to update graph habit select options
            function updateGraphHabitSelect() {
                // Clear existing options except "All Habits"
                while (graphHabitSelect.options.length > 1) {
                    graphHabitSelect.remove(1);
                }
                
                // Add an option for each habit
                habits.forEach(habit => {
                    const option = document.createElement('option');
                    option.value = habit.type;
                    option.textContent = habit.name;
                    graphHabitSelect.appendChild(option);
                });
            }
            
            // Function to update the habit graph
            function updateHabitGraph() {
                const selectedHabit = graphHabitSelect.value;
                const selectedPeriod = graphPeriodSelect.value;
                
                // Get date range based on selected period
                const endDate = new Date(currentDate);
                const startDate = new Date(currentDate);
                
                if (selectedPeriod === 'week') {
                    startDate.setDate(endDate.getDate() - 6); // Last 7 days
                } else if (selectedPeriod === 'month') {
                    startDate.setDate(1); // Start of current month
                    // Set endDate to the last day of the current month
                    endDate.setMonth(endDate.getMonth() + 1);
                    endDate.setDate(0);
                } else if (selectedPeriod === '3months') {
                    startDate.setMonth(endDate.getMonth() - 2);
                    startDate.setDate(1); // Start of 3 months ago
                    // Set endDate to the last day of the current month
                    endDate.setMonth(endDate.getMonth() + 1);
                    endDate.setDate(0);
                }
                
                // Generate dates array
                const dates = [];
                const currentDateCopy = new Date(startDate);
                
                while (currentDateCopy <= endDate) {
                    dates.push(new Date(currentDateCopy));
                    currentDateCopy.setDate(currentDateCopy.getDate() + 1);
                }
                
                // Prepare data for the chart
                const labels = dates.map(date => {
                    return `${date.getDate()}/${date.getMonth() + 1}`;
                });
                
                let datasets = [];
                
                if (selectedHabit === 'all') {
                    // Show actual count of completed habits
                    const data = dates.map(date => {
                        let completedCount = 0;
                        
                        habits.forEach(habit => {
                            const dateKey = `${date.getFullYear()}-${date.getMonth()}-${date.getDate()}-${habit.type}`;
                            if (completedDays[dateKey] === true) {
                                completedCount++;
                            }
                        });
                        
                        return completedCount;
                    });
                    
                    datasets.push({
                        label: 'Completed Habits',
                        data: data,
                        borderColor: isDarkMode ? '#818cf8' : '#4338ca',
                        backgroundColor: isDarkMode ? 'rgba(129, 140, 248, 0.2)' : 'rgba(67, 56, 202, 0.2)',
                        fill: true,
                        tension: 0.3
                    });
                } else {
                    // Show completion for a specific habit (0 or 1)
                    const habitIndex = habits.findIndex(h => h.type === selectedHabit);
                    if (habitIndex !== -1) {
                        const habit = habits[habitIndex];
                        const data = dates.map(date => {
                            const dateKey = `${date.getFullYear()}-${date.getMonth()}-${date.getDate()}-${habit.type}`;
                            return completedDays[dateKey] === true ? 1 : 0;
                        });
                        
                        // Determine color based on habit type
                        let borderColor, backgroundColor;
                        if (habit.type === 'vocab') {
                            borderColor = isDarkMode ? '#fbbf24' : '#f59e0b';
                            backgroundColor = isDarkMode ? 'rgba(251, 191, 36, 0.2)' : 'rgba(245, 158, 11, 0.2)';
                        } else if (habit.type === 'meditation') {
                            borderColor = isDarkMode ? '#34d399' : '#059669';
                            backgroundColor = isDarkMode ? 'rgba(52, 211, 153, 0.2)' : 'rgba(5, 150, 105, 0.2)';
                        } else if (habit.type === 'gaming') {
                            borderColor = isDarkMode ? '#3b82f6' : '#2563eb';
                            backgroundColor = isDarkMode ? 'rgba(59, 130, 246, 0.2)' : 'rgba(37, 99, 235, 0.2)';
                        } else {
                            borderColor = isDarkMode ? '#818cf8' : '#4338ca';
                            backgroundColor = isDarkMode ? 'rgba(129, 140, 248, 0.2)' : 'rgba(67, 56, 202, 0.2)';
                        }
                        
                        datasets.push({
                            label: habit.name,
                            data: data,
                            borderColor: borderColor,
                            backgroundColor: backgroundColor,
                            fill: true,
                            tension: 0.3
                        });
                    }
                }
                
                // Create or update chart
                if (habitChart) {
                    habitChart.data.labels = labels;
                    habitChart.data.datasets = datasets;
                    habitChart.options.scales.y.max = selectedHabit === 'all' ? habits.length : 1;
                    habitChart.options.scales.y.ticks.stepSize = 1;
                    habitChart.update();
                } else {
                    habitChart = new Chart(habitGraphCanvas, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: selectedHabit === 'all' ? habits.length : 1,
                                    ticks: {
                                        stepSize: 1,
                                        precision: 0,
                                        callback: function(value) {
                                            return value;
                                        },
                                        color: isDarkMode ? '#f8fafc' : '#1e293b'
                                    },
                                    grid: {
                                        color: isDarkMode ? 'rgba(75, 85, 99, 0.3)' : 'rgba(229, 231, 235, 0.8)'
                                    }
                                },
                                x: {
                                    ticks: {
                                        color: isDarkMode ? '#f8fafc' : '#1e293b'
                                    },
                                    grid: {
                                        color: isDarkMode ? 'rgba(75, 85, 99, 0.3)' : 'rgba(229, 231, 235, 0.8)'
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    labels: {
                                        color: isDarkMode ? '#f8fafc' : '#1e293b'
                                    }
                                },
                                tooltip: {
                                    backgroundColor: isDarkMode ? '#374151' : 'rgba(255, 255, 255, 0.9)',
                                    titleColor: isDarkMode ? '#f8fafc' : '#1e293b',
                                    bodyColor: isDarkMode ? '#f8fafc' : '#1e293b',
                                    borderColor: isDarkMode ? '#4b5563' : '#e2e8f0',
                                    borderWidth: 1
                                }
                            }
                        }
                    });
                }
            }
            
            // Add event listeners for graph controls
            graphHabitSelect.addEventListener('change', updateHabitGraph);
            graphPeriodSelect.addEventListener('change', updateHabitGraph);
            
            // Month navigation with enhanced transitions
            prevMonthBtn.addEventListener('click', function() {
                // Add button press animation
                this.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    this.style.transform = '';
                }, 150);
                
                // Slide out current month
                calendarTable.style.opacity = '0';
                calendarTable.style.transform = 'translateX(20px)';
                
                setTimeout(() => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                updateCalendar();
                    
                    // Slide in new month
                    calendarTable.style.transform = 'translateX(-20px)';
                    setTimeout(() => {
                        calendarTable.style.opacity = '1';
                        calendarTable.style.transform = 'translateX(0)';
                    }, 50);
                }, 200);
            });
            
            nextMonthBtn.addEventListener('click', function() {
                // Add button press animation
                this.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    this.style.transform = '';
                }, 150);
                
                // Slide out current month
                calendarTable.style.opacity = '0';
                calendarTable.style.transform = 'translateX(-20px)';
                
                setTimeout(() => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                updateCalendar();
                    
                    // Slide in new month
                    calendarTable.style.transform = 'translateX(20px)';
                    setTimeout(() => {
                        calendarTable.style.opacity = '1';
                        calendarTable.style.transform = 'translateX(0)';
                    }, 50);
                }, 200);
            });
            
            // Add new habit functionality
            const addHabitBtn = document.getElementById('add-habit-btn');
            addHabitBtn.addEventListener('click', function() {
                // Create modal for new habit
                const overlay = document.createElement('div');
                overlay.className = 'note-overlay';
                
                const modal = document.createElement('div');
                modal.className = 'habit-note';
                modal.style.width = '400px';
                modal.style.top = '50%';
                modal.style.left = '50%';
                modal.style.transform = 'translate(-50%, -50%)';
                
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'habit-name-input';
                input.placeholder = 'Enter habit name';
                input.maxLength = 100; // Prevent extremely long habit names
                input.value = habitName || '';
                input.style.width = '100%';
                
                // Add target toggle
                const targetToggleContainer = document.createElement('div');
                targetToggleContainer.style.marginTop = '1rem';
                targetToggleContainer.style.display = 'flex';
                targetToggleContainer.style.alignItems = 'center';
                
                const targetToggleLabel = document.createElement('label');
                targetToggleLabel.textContent = 'Enable monthly target:';
                targetToggleLabel.style.marginRight = '1rem';
                targetToggleLabel.style.fontWeight = '500';
                
                const targetToggle = document.createElement('input');
                targetToggle.type = 'checkbox';
                targetToggle.checked = false; // Default to unchecked for new habits
                targetToggle.style.width = '18px';
                targetToggle.style.height = '18px';
                
                targetToggleContainer.appendChild(targetToggleLabel);
                targetToggleContainer.appendChild(targetToggle);
                
                // Add target input
                const targetContainer = document.createElement('div');
                targetContainer.style.marginTop = '1rem';
                
                const targetLabel = document.createElement('label');
                targetLabel.textContent = 'Monthly Target (days):';
                targetLabel.style.display = 'block';
                targetLabel.style.marginBottom = '0.5rem';
                targetLabel.style.fontWeight = '500';
                
                const targetInput = document.createElement('input');
                targetInput.type = 'number';
                targetInput.min = '1';
                targetInput.max = '31';
                targetInput.className = 'habit-name-input';
                targetInput.placeholder = 'e.g., 20 days per month';
                targetInput.disabled = !targetToggle.checked; // Initially disabled if toggle is unchecked
                targetInput.style.opacity = targetToggle.checked ? '1' : '0.5';
                
                // Toggle target input visibility based on checkbox
                targetToggle.addEventListener('change', function() {
                    targetInput.disabled = !this.checked;
                    targetInput.style.opacity = this.checked ? '1' : '0.5';
                    if (!this.checked) {
                        targetInput.value = '';
                    }
                    // Update add button state
                    addButton.disabled = !input.value.trim() || (this.checked && !targetInput.value.trim());
                });
                
                targetContainer.appendChild(targetLabel);
                targetContainer.appendChild(targetInput);
                
                const actions = document.createElement('div');
                actions.className = 'note-actions';
                
                const addButton = document.createElement('button');
                addButton.className = 'note-btn note-save';
                addButton.textContent = 'Add Habit';
                addButton.disabled = true; // Initially disabled
                
                const cancelButton = document.createElement('button');
                cancelButton.className = 'note-btn note-cancel';
                cancelButton.textContent = 'Cancel';
                
                actions.appendChild(cancelButton);
                actions.appendChild(addButton);
                
                modal.appendChild(input);
                modal.appendChild(targetToggleContainer);
                modal.appendChild(targetContainer);
                modal.appendChild(actions);
                
                // Add to document
                document.body.appendChild(overlay);
                document.body.appendChild(modal);
                
                // Focus input
                input.focus();
                
                // Enable/disable add button based on input
                input.addEventListener('input', function() {
                    const nameValue = this.value.trim();
                    const targetEnabled = targetToggle.checked;
                    const targetValue = targetInput.value.trim();
                    
                    addButton.disabled = !nameValue || (targetEnabled && !targetValue);
                });
                
                targetInput.addEventListener('input', function() {
                    const nameValue = input.value.trim();
                    const targetEnabled = targetToggle.checked;
                    const targetValue = this.value.trim();
                    
                    addButton.disabled = !nameValue || (targetEnabled && !targetValue);
                });
                
                function closeModal() {
                    modal.remove();
                    overlay.remove();
                }
                
                function addHabit() {
                    const habitName = input.value.trim();
                    const targetEnabled = targetToggle.checked;
                    const targetValue = parseInt(targetInput.value);
                    
                    if (habitName) {
                        // Check for duplicate habit names
                        const isDuplicate = habits.some(h => h.name.toLowerCase() === habitName.toLowerCase());
                        
                        if (isDuplicate) {
                            alert('A habit with this name already exists. Please use a different name.');
                            return;
                        }
                        
                        // Create unique ID for the new habit
                        const habitType = 'custom-' + Date.now();
                        
                        // Add to habits array
                        habits.push({
                            name: habitName,
                            type: habitType
                        });
                        
                        // Add target if enabled and provided
                        if (targetEnabled && !isNaN(targetValue) && targetValue > 0) {
                            habitTargets[habitType] = {
                                target: targetValue
                            };
                        }
                        
                        // Save to localStorage after adding new habit
                        saveToLocalStorage();
                        
                        // Refresh the calendar to show the new habit
                        updateCalendar();
                        updateHabitGraph();
                        closeModal();
                    }
                }
                
                // Add event listeners
                addButton.addEventListener('click', addHabit);
                cancelButton.addEventListener('click', closeModal);
                overlay.addEventListener('click', closeModal);
                
                // Handle Enter and Escape keys
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !addButton.disabled) {
                        addHabit();
                    } else if (e.key === 'Escape') {
                        closeModal();
                    }
                });
                
                targetInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !addButton.disabled) {
                        addHabit();
                    } else if (e.key === 'Escape') {
                        closeModal();
                    }
                });
            });
            
            // Function to update heat map for a specific day with smoother transitions
            function updateHeatMapForDay(year, month, dayNumber) {
                // Find the header cell for this day - using attribute selector instead of index
                const dayHeaderCell = document.querySelector(`.header-cell.day-cell:nth-child(${dayNumber + 1})`);
                
                if (!dayHeaderCell) return; // Safety check
                
                // Count completed habits for this day
                let completedCount = 0;
                let totalHabits = habits.length;
                
                if (totalHabits === 0) {
                    // No habits case - set transparent background
                    dayHeaderCell.style.backgroundColor = 'transparent';
                    return;
                }
                
                habits.forEach(habit => {
                    const dateKey = `${year}-${month}-${dayNumber}-${habit.type}`;
                    if (completedDays[dateKey] === true) {
                        completedCount++;
                    }
                });
                
                // Calculate heat level
                let backgroundColor = 'transparent';
                const completionRate = completedCount / totalHabits;
                
                if (completionRate > 0) {
                    // Use HSL for smooth color transition with different values for dark mode
                    let hue, saturation, lightness, opacity;
                    
                    if (isDarkMode) {
                        // Dark mode heat map colors - original
                        if (completionRate <= 0.5) {
                            // Red (0) to Yellow (60)
                            hue = completionRate * 2 * 60;
                            lightness = 45 + (completionRate * 10); // 45-55% lightness for dark mode
                            saturation = 85 - (completionRate * 10); // Slightly desaturate towards yellow
                        } else {
                            // Yellow (60) to Green (120)
                            hue = 60 + (completionRate - 0.5) * 2 * 60;
                            lightness = 55 - ((completionRate - 0.5) * 15); // Slightly darker for green
                            saturation = 75 + ((completionRate - 0.5) * 20); // More saturated for green
                        }
                        // Opacity increases with completion but stays subtle
                        opacity = 0.4 + (completionRate * 0.4);
                    } else {
                        // Light mode heat map colors - original
                        if (completionRate <= 0.5) {
                            // Red (0) to Yellow (60)
                            hue = completionRate * 2 * 60;
                            // Start with lighter red and transition to yellow
                            lightness = 55 + (completionRate * 10); // 55-65% lightness
                            saturation = 85 - (completionRate * 10); // Slightly desaturate towards yellow
                        } else {
                            // Yellow (60) to Green (120)
                            hue = 60 + (completionRate - 0.5) * 2 * 60;
                            lightness = 65 - ((completionRate - 0.5) * 15); // Slightly darker for green
                            saturation = 75 + ((completionRate - 0.5) * 20); // More saturated for green
                        }
                        // Opacity increases with completion but stays subtle
                        opacity = 0.35 + (completionRate * 0.45);
                    }
                    
                    backgroundColor = `hsla(${hue}, ${saturation}%, ${lightness}%, ${opacity})`;
                } else {
                    // No completion color
                    if (isDarkMode) {
                        backgroundColor = 'hsla(0, 70%, 45%, 0.35)'; // Darker, more subdued red for dark mode
                    } else {
                        backgroundColor = 'hsla(0, 85%, 65%, 0.35)'; // Original light mode red
                    }
                }
                
                // Update the background color with transition
                dayHeaderCell.style.transition = 'background-color 0.3s ease';
                dayHeaderCell.style.backgroundColor = backgroundColor;
            }
            
            // Load and add sample habits if none exist
            function addSampleHabits() {
                habits = [
                    { name: 'Meditation', type: 'meditation' },
                    { name: 'Exercise', type: 'exercise' },
                    { name: 'Reading', type: 'reading' }
                ];
                saveToLocalStorage();
            }
            
            // Debug logs to understand what's happening
            console.log('Habits:', habits);
            console.log('Goal data:', goalData);
            
            // Add sample habits if none exist
            if (habits.length === 0) {
                console.log('No habits found, adding sample habits');
                addSampleHabits();
            }
            
            // Update calendar and UI
            updateCalendar();
            
            // Update target bars after calendar is rendered
            setTimeout(updateTargetBars, 100);
            
            // Initialize the goal section
            updateGoalSection();
            
            // Set up the goal button
            if (goalButton) {
                goalButton.addEventListener('click', function() {
                    showGoalModal();
                });
                
                // Update goal button appearance if a goal exists
                if (goalData) {
                    goalButton.title = goalData.text;
                    goalButton.textContent = goalData.emoji || 'üéØ';
                    goalButton.style.color = 'var(--primary-color)';
                } else {
                    goalButton.title = 'Set Monthly Goal';
                    goalButton.textContent = 'üéØ';
                    goalButton.style.color = '';
                }
            }
            
            // Function to update the goal section
            function updateGoalSection() {
                // Make sure the goal section exists
                const goalSection = document.getElementById('goal-section');
                if (!goalSection) return;
                
                // Clear previous content
                goalSection.innerHTML = '';
                
                if (goalData) {
                    // Create goal container
                    const goalContainer = document.createElement('div');
                    goalContainer.className = 'goal-container';
                    
                    // Create goal content
                    const goalContent = document.createElement('div');
                    goalContent.className = 'goal-content';
                    
                    // Add emoji and text
                    const goalEmoji = document.createElement('span');
                    goalEmoji.className = 'goal-emoji';
                    goalEmoji.textContent = goalData.emoji || 'üéØ';
                    
                    const goalText = document.createElement('div');
                    goalText.className = 'goal-text';
                    goalText.textContent = goalData.text;
                    
                    goalContent.appendChild(goalEmoji);
                    goalContent.appendChild(goalText);
                    
                    // Create action buttons
                    const goalActions = document.createElement('div');
                    goalActions.className = 'goal-actions';
                    
                    const editGoalBtn = document.createElement('button');
                    editGoalBtn.className = 'edit-goal-btn';
                    editGoalBtn.innerHTML = '‚úèÔ∏è';
                    editGoalBtn.title = 'Edit Goal';
                    
                    const deleteGoalBtn = document.createElement('button');
                    deleteGoalBtn.className = 'delete-goal-btn';
                    deleteGoalBtn.innerHTML = 'üóëÔ∏è';
                    deleteGoalBtn.title = 'Delete Goal';
                    
                    goalActions.appendChild(editGoalBtn);
                    goalActions.appendChild(deleteGoalBtn);
                    
                    // Add event listeners for edit and delete buttons
                    editGoalBtn.addEventListener('click', function() {
                        showGoalModal(goalData);
                    });
                    
                    deleteGoalBtn.addEventListener('click', function() {
                        if (confirm('Are you sure you want to delete this goal?')) {
                            goalData = null;
                            saveToLocalStorage();
                            updateGoalSection();
                        }
                    });
                    
                    // Append content and actions to container
                    goalContainer.appendChild(goalContent);
                    goalContainer.appendChild(goalActions);
                    
                    goalSection.appendChild(goalContainer);
                } else {
                    // Create empty goal container with "Add Goal" button
                    const emptyGoalContainer = document.createElement('div');
                    emptyGoalContainer.className = 'goal-container';
                    
                    const emptyGoalContent = document.createElement('div');
                    emptyGoalContent.className = 'goal-content';
                    
                    const emptyGoalEmoji = document.createElement('span');
                    emptyGoalEmoji.className = 'goal-emoji';
                    emptyGoalEmoji.textContent = 'üéØ';
                    
                    const emptyGoalText = document.createElement('div');
                    emptyGoalText.className = 'goal-text goal-placeholder';
                    emptyGoalText.textContent = 'No goal set for this month';
                    
                    emptyGoalContent.appendChild(emptyGoalEmoji);
                    emptyGoalContent.appendChild(emptyGoalText);
                    
                    const addGoalBtn = document.createElement('button');
                    addGoalBtn.className = 'add-goal-btn';
                    addGoalBtn.textContent = '+ Add Goal';
                    addGoalBtn.addEventListener('click', function() {
                        showGoalModal();
                    });
                    
                    emptyGoalContainer.appendChild(emptyGoalContent);
                    emptyGoalContainer.appendChild(addGoalBtn);
                    
                    goalSection.appendChild(emptyGoalContainer);
                }
            }
            
            // Function to show a temporary notification with the goal
            function showGoalNotification(goal) {
                // Create notification element
                const notification = document.createElement('div');
                notification.style.position = 'fixed';
                notification.style.bottom = '20px';
                notification.style.right = '20px';
                notification.style.padding = '1rem 1.5rem';
                notification.style.background = 'var(--bg-color)';
                notification.style.boxShadow = 'var(--shadow-md)';
                notification.style.borderRadius = 'var(--radius-md)';
                notification.style.border = '1px solid var(--border-color)';
                notification.style.maxWidth = '300px';
                notification.style.zIndex = '1000';
                notification.style.display = 'flex';
                notification.style.alignItems = 'center';
                notification.style.gap = '0.75rem';
                notification.style.transform = 'translateY(20px)';
                notification.style.opacity = '0';
                notification.style.transition = 'all 0.3s ease';
                
                // Add emoji and text
                const emoji = document.createElement('span');
                emoji.style.fontSize = '1.5rem';
                emoji.textContent = goal.emoji || 'üéØ';
                
                const text = document.createElement('div');
                text.innerHTML = `<strong>Monthly Goal:</strong><br>${goal.text}`;
                text.style.fontSize = '0.9rem';
                text.style.color = 'var(--text-color)';
                
                notification.appendChild(emoji);
                notification.appendChild(text);
                
                // Add to document
                document.body.appendChild(notification);
                
                // Animate in
                setTimeout(() => {
                    notification.style.transform = 'translateY(0)';
                    notification.style.opacity = '1';
                }, 10);
                
                // Remove after 5 seconds
                setTimeout(() => {
                    notification.style.transform = 'translateY(20px)';
                    notification.style.opacity = '0';
                    setTimeout(() => {
                        notification.remove();
                    }, 300);
                }, 5000);
            }
            
            // Function to show goal modal
            function showGoalModal(existingGoal = null) {
                // Create overlay and modal
                const overlay = document.createElement('div');
                overlay.className = 'note-overlay';
                
                const modal = document.createElement('div');
                modal.className = 'habit-note';
                modal.style.width = '500px';
                modal.style.top = '50%';
                modal.style.left = '50%';
                modal.style.transform = 'translate(-50%, -50%)';
                
                const modalTitle = document.createElement('h3');
                modalTitle.style.marginBottom = '1rem';
                modalTitle.style.fontSize = '1.2rem';
                modalTitle.style.fontWeight = '600';
                modalTitle.textContent = existingGoal ? 'Edit Your Goal' : 'Set Your Goal';
                
                // Create emoji selector
                const emojiRow = document.createElement('div');
                emojiRow.style.display = 'flex';
                emojiRow.style.alignItems = 'center';
                emojiRow.style.marginBottom = '1rem';
                
                const emojiLabel = document.createElement('label');
                emojiLabel.textContent = 'Choose an icon:';
                emojiLabel.style.marginRight = '1rem';
                emojiLabel.style.fontWeight = '500';
                
                const emojiOptions = ['üéØ', '‚ú®', 'üöÄ', 'üí™', 'üìà', 'üèÜ', '‚≠ê', 'üåü'];
                const emojiGrid = document.createElement('div');
                emojiGrid.style.display = 'flex';
                emojiGrid.style.flexWrap = 'wrap';
                emojiGrid.style.gap = '0.5rem';
                
                let selectedEmoji = existingGoal ? existingGoal.emoji : 'üéØ';
                
                emojiOptions.forEach(emoji => {
                    const emojiBtn = document.createElement('button');
                    emojiBtn.type = 'button';
                    emojiBtn.textContent = emoji;
                    emojiBtn.style.fontSize = '1.5rem';
                    emojiBtn.style.width = '40px';
                    emojiBtn.style.height = '40px';
                    emojiBtn.style.display = 'flex';
                    emojiBtn.style.alignItems = 'center';
                    emojiBtn.style.justifyContent = 'center';
                    emojiBtn.style.border = emoji === selectedEmoji ? 
                        `2px solid var(--primary-color)` : 
                        '1px solid var(--border-color)';
                    emojiBtn.style.borderRadius = 'var(--radius-sm)';
                    emojiBtn.style.background = 'transparent';
                    emojiBtn.style.cursor = 'pointer';
                    
                    emojiBtn.addEventListener('click', function() {
                        // Deselect all emojis
                        emojiGrid.querySelectorAll('button').forEach(btn => {
                            btn.style.border = '1px solid var(--border-color)';
                        });
                        
                        // Select this emoji
                        this.style.border = `2px solid var(--primary-color)`;
                        selectedEmoji = emoji;
                    });
                    
                    emojiGrid.appendChild(emojiBtn);
                });
                
                emojiRow.appendChild(emojiLabel);
                emojiRow.appendChild(emojiGrid);
                
                // Create goal input
                const inputLabel = document.createElement('label');
                inputLabel.textContent = 'Your goal:';
                inputLabel.style.display = 'block';
                inputLabel.style.marginBottom = '0.5rem';
                inputLabel.style.fontWeight = '500';
                
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'habit-name-input';
                input.placeholder = 'Enter your goal for this month';
                input.value = existingGoal ? existingGoal.text : '';
                input.maxLength = 300;
                input.style.width = '100%';
                
                // Create action buttons
                const actions = document.createElement('div');
                actions.className = 'note-actions';
                actions.style.marginTop = '1.5rem';
                
                const saveButton = document.createElement('button');
                saveButton.className = 'note-btn note-save';
                saveButton.textContent = existingGoal ? 'Update Goal' : 'Save Goal';
                saveButton.disabled = !input.value.trim();
                
                const cancelButton = document.createElement('button');
                cancelButton.className = 'note-btn note-cancel';
                cancelButton.textContent = 'Cancel';
                
                actions.appendChild(cancelButton);
                actions.appendChild(saveButton);
                
                // Add all elements to modal
                modal.appendChild(modalTitle);
                modal.appendChild(emojiRow);
                modal.appendChild(inputLabel);
                modal.appendChild(input);
                modal.appendChild(actions);
                
                // Add to document
                document.body.appendChild(overlay);
                document.body.appendChild(modal);
                
                // Focus input
                setTimeout(() => input.focus(), 100);
                
                // Enable/disable save button based on input
                input.addEventListener('input', function() {
                    saveButton.disabled = !this.value.trim();
                });
                
                function closeModal() {
                    modal.remove();
                    overlay.remove();
                }
                
                function saveGoal() {
                    const goalText = input.value.trim();
                    
                    if (goalText) {
                        goalData = {
                            text: goalText,
                            emoji: selectedEmoji,
                            createdAt: existingGoal ? existingGoal.createdAt : new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };
                        
                        // Update goal button
                        if (goalButton) {
                            goalButton.title = goalData.text;
                            goalButton.textContent = goalData.emoji;
                            goalButton.style.color = 'var(--primary-color)';
                        }
                        
                        // Update goal section
                        updateGoalSection();
                        
                        saveToLocalStorage();
                        closeModal();
                    }
                }
                
                // Add event listeners
                saveButton.addEventListener('click', saveGoal);
                cancelButton.addEventListener('click', closeModal);
                overlay.addEventListener('click', function(e) {
                    if (e.target === overlay) {
                        closeModal();
                    }
                });
                
                // Handle Enter and Escape keys
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !saveButton.disabled) {
                        saveGoal();
                    } else if (e.key === 'Escape') {
                        closeModal();
                    }
                });
            }
            
            // Show goal notification on page load if a goal exists
            if (goalData) {
                setTimeout(() => {
                    // Use updateGoalSection instead of notification
                    updateGoalSection();
                }, 1000);
            }
            
            // Function to update all target bars for real-time feedback
            function updateTargetBars() {
                // For each habit row that has a target
                habits.forEach(habit => {
                    const habitType = habit.type;
                    const targetData = habitTargets[habitType];
                    
                    if (targetData && targetData.target > 0) {
                        // Find the target elements
                        const habitRow = document.querySelector(`[data-habit-type="${habitType}"]`);
                        if (!habitRow) return;
                        
                        const targetBar = habitRow.querySelector('.habit-target');
                        if (!targetBar) return;
                        
                        const targetProgress = habitRow.querySelector('.habit-target-progress');
                        const targetLabel = habitRow.querySelector('.habit-target-label');
                        
                        if (!targetProgress || !targetLabel) return;
                        
                        // Count completed days for this habit in the current month
                        const year = currentDate.getFullYear();
                        const month = currentDate.getMonth();
                        const daysInMonth = getDaysInMonth(year, month);
                        
                        let completedCount = 0;
                        for (let i = 1; i <= daysInMonth; i++) {
                            const dateKey = `${year}-${month}-${i}-${habitType}`;
                            if (completedDays[dateKey] === "true") {
                                completedCount++;
                            }
                        }
                        
                        // Update progress bar and label
                        const progressPercent = Math.min(100, (completedCount / targetData.target) * 100);
                        targetProgress.style.width = `${progressPercent}%`;
                        targetLabel.textContent = `${completedCount}/${targetData.target}`;
                    }
                });
            }
            
            // Enhanced habit cell click with haptic feedback and animations
            function enhancedHabitCellClick(cell, dateKey) {
                console.log("CLICK - Starting cell click handler for:", dateKey);
                console.log("CLICK - Current localStorage state:", localStorage.getItem('dailyHabits_completedDays'));
                
                // Add ripple effect
                const rect = cell.getBoundingClientRect();
                const x = rect.width / 2;
                const y = rect.height / 2;
                
                const ripple = document.createElement('div');
                ripple.className = 'ripple-effect';
                cell.appendChild(ripple);
                
                ripple.animate([
                    { top: y + 'px', left: x + 'px', width: '0', height: '0', opacity: 0.5 },
                    { top: y + 'px', left: x + 'px', width: '150%', height: '150%', opacity: 0 }
                ], {
                    duration: 400,
                    easing: 'cubic-bezier(0.25, 0.1, 0.25, 1)'
                }).onfinish = () => ripple.remove();
                
                // Toggle completion state with enhanced animation
                let newState;
                
                if (cell.classList.contains('completed')) {
                    cell.classList.remove('completed');
                    // Very important: Store as STRING "true"/"false", not boolean
                    newState = "false";
                    completedDays[dateKey] = newState;
                    console.log(`CLICK - Marked ${dateKey} as "false" (incomplete)`);
                    triggerHapticFeedback('light');
                } else {
                    cell.classList.remove('crossed');
                    cell.classList.add('completed');
                    // Very important: Store as STRING "true"/"false", not boolean
                    newState = "true";
                    completedDays[dateKey] = newState;
                    console.log(`CLICK - Marked ${dateKey} as "true" (completed)`);
                    triggerHapticFeedback('success');
                    
                    // Check if this completes a streak milestone (5, 10, 25, etc.)
                    const habitType = dateKey.split('-')[3];
                    const streak = calculateStreak(habitType);
                    
                    if (streak === 5 || streak === 10 || streak === 25 || streak === 50 || streak === 100) {
                        // Show confetti for streak milestone
                        const cellRect = cell.getBoundingClientRect();
                        showConfetti(cellRect.left + cellRect.width / 2, cellRect.top + cellRect.height / 2);
                        
                        // Show achievement tooltip
                        showTooltip(`üî• ${streak} day streak!`, cellRect.left, cellRect.top - 40);
                        setTimeout(hideTooltip, 2000);
                    }
                }
                
                // Update heat map and save
                const [year, month, day] = dateKey.split('-');
                updateHeatMapForDay(parseInt(year), parseInt(month), parseInt(day));
                
                // Update target bars in real-time
                updateTargetBars();
                
                // Force an immediate save to ensure data is persisted
                const saveSuccess = saveToLocalStorage();
                console.log(`CLICK - Data saved to localStorage: ${saveSuccess}`);
                
                // Pre-verification to see what's actually in the browser's localStorage
                const rawStorageBeforeVerify = localStorage.getItem('dailyHabits_completedDays');
                console.log(`CLICK - Raw localStorage value:`, rawStorageBeforeVerify);
                
                // Make multiple verification attempts to ensure data is properly saved
                const verifyData = () => {
                    const savedData = localStorage.getItem('dailyHabits_completedDays');
                    if (savedData) {
                        try {
                            const parsed = JSON.parse(savedData);
                            console.log(`CLICK - Verification check - Is ${dateKey} marked correctly:`, parsed[dateKey]);
                            
                            // If the data doesn't match what we expect, try saving again
                            const expectedValue = newState; // Use the local variable we set earlier
                            if (parsed[dateKey] !== expectedValue) {
                                console.log(`CLICK - Data mismatch! Expected ${expectedValue} but got ${parsed[dateKey]}. Trying to save again...`);
                                // Make sure memory matches what we want
                                completedDays[dateKey] = newState;
                                // Try saving again
                                saveToLocalStorage();
                                
                                // Also ensure UI matches our data
                                if (newState === "true" && !cell.classList.contains('completed')) {
                                    cell.classList.add('completed');
                                } else if (newState === "false" && cell.classList.contains('completed')) {
                                    cell.classList.remove('completed');
                                }
                            }
                        } catch (e) {
                            console.error("CLICK - Error parsing saved data:", e);
                            // Try saving again
                            saveToLocalStorage();
                        }
                    } else {
                        console.error("CLICK - No saved data found in verification!");
                        // Try to save again
                        saveToLocalStorage();
                    }
                };
                
                // Verify multiple times with increasing delays
                setTimeout(verifyData, 100);
                setTimeout(verifyData, 500);
                setTimeout(verifyData, 1000);
                
                updateHabitGraph();
            }
        });
        
        // Add haptic feedback function (for supported devices)
        function triggerHapticFeedback(intensity) {
            if (navigator.vibrate) {
                switch(intensity) {
                    case 'light':
                        navigator.vibrate(10);
                        break;
                    case 'medium':
                        navigator.vibrate(15);
                        break;
                    case 'heavy':
                        navigator.vibrate([10, 30, 10]);
                        break;
                    case 'success':
                        navigator.vibrate([10, 50, 20]);
                        break;
                    default:
                        navigator.vibrate(10);
                }
            }
        }
        
        // Add confetti animation for achievements
        function showConfetti(x, y) {
            const colors = ['#0071e3', '#42a5f5', '#34c759', '#ffcc00', '#ff9500'];
            const confettiCount = 50;
            
            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = `${x}px`;
                confetti.style.top = `${y}px`;
                confetti.style.width = `${Math.random() * 8 + 4}px`;
                confetti.style.height = `${Math.random() * 8 + 4}px`;
                confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                
                document.body.appendChild(confetti);
                
                const angle = Math.random() * Math.PI * 2;
                const velocity = 5 + Math.random() * 10;
                const tx = x + Math.cos(angle) * 100 * Math.random();
                const ty = y + Math.sin(angle) * 100 * Math.random();
                
                confetti.animate([
                    { transform: `translate(0, 0) rotate(0deg)`, opacity: 1 },
                    { transform: `translate(${tx - x}px, ${ty - y}px) rotate(${Math.random() * 360}deg)`, opacity: 0 }
                ], {
                    duration: 1000 + Math.random() * 1000,
                    easing: 'cubic-bezier(0.25, 0.1, 0.25, 1)'
                }).onfinish = () => confetti.remove();
            }
        }
        
        // Add tooltip functionality
        const tooltip = document.getElementById('tooltip');
        
        function showTooltip(text, x, y) {
            tooltip.textContent = text;
            tooltip.style.left = `${x}px`;
            tooltip.style.top = `${y}px`;
            tooltip.classList.add('visible');
        }

        function hideTooltip() {
            tooltip.classList.remove('visible');
        }
        
        // Add streak tracking functionality
        function calculateStreak(habitType) {
            const today = new Date();
            let currentStreak = 0;
            let date = new Date(today);
            
            while (true) {
                const year = date.getFullYear();
                const month = date.getMonth();
                const day = date.getDate();
                const dateKey = `${year}-${month}-${day}-${habitType}`;
                
                if (completedDays[dateKey] === true) {
                    currentStreak++;
                    date.setDate(date.getDate() - 1);
                } else {
                    break;
                }
            }
            
            return currentStreak;
        }
    </script>
    
    <script>
        // Add a final safety check when the window loads
        window.onload = function() {
            console.log("Window loaded - Running final safety checks");
            
            try {
                // Ensure all global variables are defined to prevent ReferenceError
                if (typeof habits === 'undefined') habits = [];
                if (typeof completedDays === 'undefined') completedDays = {};
                if (typeof habitNotes === 'undefined') habitNotes = {};
                if (typeof habitTargets === 'undefined') habitTargets = {};
                
                // Check if we have data in localStorage
                const savedHabits = localStorage.getItem('dailyHabits_habits');
                const savedCompletedDays = localStorage.getItem('dailyHabits_completedDays');
                
                console.log("Window.onload check:", {
                    habitsInMemory: habits.length,
                    completedDaysInMemory: Object.keys(completedDays).length,
                    habitsInStorage: savedHabits ? "present" : "absent",
                    completedDaysInStorage: savedCompletedDays ? "present" : "absent"
                });
                
                // Look for UI elements that should show our data
                const habitRows = document.querySelectorAll('.habit-row');
                const needsUIRefresh = (savedHabits && habits.length > 0 && habitRows.length === 0);
                
                // Check if localStorage and memory are out of sync
                let needsDataReload = false;
                
                if (savedHabits && (!habits || habits.length === 0)) {
                    console.log("Habits data mismatch - stored data but empty memory");
                    needsDataReload = true;
                }
                
                if (savedCompletedDays && (!completedDays || Object.keys(completedDays).length === 0)) {
                    console.log("CompletedDays data mismatch - stored data but empty memory");
                    needsDataReload = true;
                }
                
                // If anything needs fixing, reload and refresh
                if (needsDataReload || needsUIRefresh) {
                    console.log("Found issues - reloading data and refreshing UI");
                    
                    // Reload data from localStorage
                    loadFromLocalStorage();
                    
                    // Refresh the UI
                    if (typeof updateCalendar === 'function') {
                        updateCalendar();
                        console.log("Calendar updated");
                    }
                    
                    // Update other UI elements with delays to ensure rendering
                    setTimeout(function() {
                        if (typeof updateTargetBars === 'function') {
                            updateTargetBars();
                            console.log("Target bars updated");
                        }
                    }, 100);
                    
                    setTimeout(function() {
                        if (typeof updateHabitGraph === 'function') {
                            updateHabitGraph();
                            console.log("Habit graph updated");
                        }
                        
                        if (typeof updateGoalSection === 'function') {
                            updateGoalSection();
                            console.log("Goal section updated");
                        }
                    }, 200);
                    
                    // Final check after reload
                    setTimeout(function() {
                        console.log("Final state after reload:", {
                            habitsInMemory: habits.length,
                            completedDaysInMemory: Object.keys(completedDays).length,
                            habitRowsInUI: document.querySelectorAll('.habit-row').length
                        });
                    }, 500);
                } else {
                    console.log("Data appears to be in sync, no reload needed");
                }
            } catch (e) {
                console.error("Error in window.onload safety check:", e);
            }
        };
    </script>
</body>
</html>
